<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --dragon-blue: #00d4ff; --dragon-dark: #001a33; }
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Oswald', sans-serif; }

        /* EJDERHA KARTI */
        .dragon-card {
            position: absolute; left: -1500px; top: 100px;
            display: flex; align-items: center;
            background: linear-gradient(135deg, var(--dragon-dark) 0%, #000 100%);
            border: 4px solid var(--dragon-blue);
            border-radius: 80px 20px 80px 20px;
            padding: 20px 60px;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.6), inset 0 0 20px var(--dragon-blue);
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 10;
        }

        /* GİTME VE GELME ANİMASYONU */
        .dragon-card.active { left: 50px; animation: dragonShake 0.5s ease-in-out; }
        .dragon-card.exit { left: -1500px; opacity: 0; transform: skewX(30deg); }

        @keyframes dragonShake {
            0% { transform: translateX(-100px); }
            50% { transform: translateX(20px); }
            100% { transform: translateX(0); }
        }

        /* PROFİL VE EFEKT */
        .pfp-container { position: relative; }
        .pfp { 
            width: 130px; height: 130px; border-radius: 50%; 
            border: 5px solid var(--dragon-blue); filter: drop-shadow(0 0 15px var(--dragon-blue));
        }
        .combo-badge {
            position: absolute; bottom: -10px; right: -10px;
            background: #ff0055; color: white; padding: 5px 15px;
            border-radius: 50px; font-size: 25px; border: 3px solid white;
            display: none; transform: scale(1.2);
        }

        .info { margin-left: 40px; }
        .user-name { font-size: 55px; color: #fff; margin: 0; text-shadow: 0 0 10px var(--dragon-blue); }
        .user-action { font-size: 30px; color: var(--dragon-blue); margin: 0; text-transform: uppercase; }

        /* TELEGRAM LOGO */
        .telegram-tag {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; align-items: center; gap: 10px;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 50px; border: 2px solid var(--dragon-blue);
            color: white; font-size: 18px;
        }
        .tg-icon { width: 30px; }

    </style>
</head>
<body>

<div id="card" class="dragon-card">
    <div class="pfp-container">
        <img id="user-pfp" src="" class="pfp">
        <div id="combo" class="combo-badge">x1</div>
    </div>
    <div class="info">
        <p id="user-name" class="user-name"></p>
        <p id="user-action" class="user-action"></p>
    </div>
</div>

<div class="telegram-tag">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" class="tg-icon">
    <span>@katilbebek</span>
</div>

<script>
    const socket = io("http://localhost:3000");
    const k = new URLSearchParams(window.location.search).get('k');
    if(k) socket.emit('set-user', k);

    const card = document.getElementById('card');
    const comboBadge = document.getElementById('combo');
    let activeUser = null;
    let hideTimer;

    function dragonFire() {
        confetti({
            particleCount: 100, spread: 70, origin: { x: 0, y: 0.6 },
            colors: ['#00d4ff', '#0055ff', '#ffffff']
        });
    }

    socket.on('event', (data) => {
        // KOMBO MANTIĞI: Eğer aynı kişi hediye gönderiyorsa kartı kapatma, güncelle
        if (activeUser === data.uniqueId && data.type === 'gift') {
            updateCard(data);
        } else {
            showCard(data);
        }
    });

    function showCard(data) {
        clearTimeout(hideTimer);
        activeUser = data.uniqueId;
        
        document.getElementById('user-pfp').src = data.profilePictureUrl;
        document.getElementById('user-name').innerText = `@${data.uniqueId}`;
        document.getElementById('user-action').innerText = data.text;
        
        if(data.type === 'gift' && data.repeatCount > 1) {
            comboBadge.style.display = "block";
            comboBadge.innerText = `x${data.repeatCount}`;
        } else {
            comboBadge.style.display = "none";
        }

        card.classList.remove('exit');
        card.classList.add('active');
        dragonFire();

        hideTimer = setTimeout(exitCard, 6000);
    }

    function updateCard(data) {
        clearTimeout(hideTimer);
        document.getElementById('user-action').innerText = data.text;
        if(data.repeatCount > 1) {
            comboBadge.style.display = "block";
            comboBadge.innerText = `x${data.repeatCount}`;
            // Küçük bir sarsıntı efekti verelim
            card.style.transform = "scale(1.05)";
            setTimeout(() => card.style.transform = "scale(1)", 100);
        }
        hideTimer = setTimeout(exitCard, 6000);
    }

    function exitCard() {
        card.classList.add('exit');
        card.classList.remove('active');
        activeUser = null;
    }
</script>
</body>
</html>